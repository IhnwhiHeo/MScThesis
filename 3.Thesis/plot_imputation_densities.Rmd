---
title: "Plot density of imputations"
output: html_notebook
---

```{r echo=TRUE, message=FALSE, warning=FALSE}
# set-up environment
library(mice) # Data imputation
library(dplyr) # Data manipulation
# library(magrittr)
# library(broom)
library(ggplot2)
# library(purrr)
set.seed(123)

# parameters
M <- 20
T_max <- 100

# impute missingness with one iteration
dat <- nhanes

####
# this should be repeated T times
####
plot <- list()
distr <- list()

for (it in 1:T_max){
if (it == 1) {
  mids <- mice(dat, maxit = 1, m = M, print = FALSE)
} else {
# add an iteration
mids <- mice.mids(mids, maxit = 1, printFlag = FALSE)}

# plot density of imputed values
imputed_values <- mids[["imp"]]$bmi %>% mutate(case = row_number()) %>%  tidyr::gather("imp", "value", 1:M) %>% .[order(.$case, .$imp), ] #%>% group_by(case) %>% mutate(case_mean = mean(value)) %>% ungroup()
distr[[it]] <- case_mean <- imputed_values %>% group_by(case) %>% summarise(mu = mean(value), sigma = sd(value)) 

# plot hist per case
plot[[it]] <- imputed_values %>% ggplot(aes(x = value)) + 
  geom_histogram() +
  geom_vline(data = case_mean, mapping = aes(xintercept = mu)) +
  facet_wrap(~case)
 
# # plot density per case
# imputed_values %>% ggplot(aes(x = value)) +
#   geom_histogram(aes(y = ..density..)) +
#   geom_density() +
#   geom_vline(data = case_mean, mapping = aes(xintercept = mu)) +
#   facet_wrap(~case)
}

# # this is just the between chain variance, right?
# average_sd <- distr %>% purrr::map(~{mean(.$sigma)})
# plot.ts(average_sd) #is this == plot(mids)?

# now split by case
purrr::map(1:9, function(x) purrr::map(distr, ~{.$sigma[.$case==x]})) %>% purrr::map(~plot.ts(.x))

# or with ggplot
sd_per_case_per_it <- purrr::map(1:9, function(x) purrr::map_dbl(distr, ~{.$sigma[.$case==x]})) %>% as.data.frame() %>% mutate(nr_it = row_number()) 

colnames(sd_per_case_per_it) <- c(1:9, "nr_it") 

sd_per_case_per_it %>%  tidyr::gather("case", "sd", 1:9) %>% ggplot() + geom_line(aes(x = nr_it, y = sd)) + facet_wrap(~case)
sd_per_case_per_it %>%  tidyr::gather("case", "sd", 1:9) %>% ggplot(aes(x = nr_it, y = sd, col = case)) + geom_line() + geom_smooth(se = F) 


```

